# 匠心出品：看图学习，从输入URL到网页显示完成都发生了哪些事情？
> 白话理解一下浏览器都需要做哪些事情？
> 1. 需要知道我们输入了什么？
> 2. 创建网络连接
> 3. 从服务端获取数据
> 4. 客户端渲染数据
> 5. 用户感知到页面的渲染

**目标**
- 1. 了解整个流程；
- 2. 构建自己的知识体系；
- 3. 知道如何提升网站性能；

> 输入URL就相当于对电脑执行了一条指令。
> 我们要知道计算机如何去执行这条指令。

> Tips: 整个基本包含了网站开发的全过程。

阶段划分:
- 岗位职责：需求评审 技术评审 产品设计 UI设计 UED工程师 前端开发 后端开发 品控 网站运维 服务器工程师 运营团队 测试团队 =》用户



## 1. 开启线程
> 我们需要知道浏览器是如何开始执行这个指令的？
> 从浏览器接收url到开启网络请求线程（这一部分可以展开浏览器的机制以及进程与线程之间的关系）

### 1.0 事件监听：
> 浏览器一直监听输入框的状态，当状态改变时，就会触发指令的执行。
> 根据输入的内容，浏览器会按照自己的规则，在缓存中进行查询和推荐。例如：输入b,就会联想出很多相关的网站域名，并且自动添加协议名称，这一般取决于浏览记录。
> 1. 键盘事件
> 2. 触屏事件

### 1.1 浏览器机制

浏览器的高层结构
浏览器的主要组件为 (1.1)：

用户界面 - 包括地址栏、前进/后退按钮、书签菜单等。除了浏览器主窗口显示的您请求的页面外，其他显示的各个部分都属于用户界面。
浏览器引擎 - 在用户界面和呈现引擎之间传送指令。
呈现引擎 - 负责显示请求的内容。如果请求的内容是 HTML，它就负责解析 HTML 和 CSS 内容，并将解析后的内容显示在屏幕上。
网络 - 用于网络调用，比如 HTTP 请求。其接口与平台无关，并为所有平台提供底层实现。
用户界面后端 - 用于绘制基本的窗口小部件，比如组合框和窗口。其公开了与平台无关的通用接口，而在底层使用操作系统的用户界面方法。
JavaScript 解释器。用于解析和执行 JavaScript 代码。
数据存储。这是持久层。浏览器需要在硬盘上保存各种数据，例如 Cookie。新的 HTML 规范 (HTML5) 定义了“网络数据库”，这是一个完整（但是轻便）的浏览器内数据库。

图：浏览器的主要组件。
值得注意的是，和大多数浏览器不同，Chrome 浏览器的每个标签页都分别对应一个呈现引擎实例。每个标签页都是一个独立的进程。

### 1.2 进程与线程的关系
进程可能包括主控进程，插件进程，GPU，tab页（浏览器内核）等等。

Browser进程：浏览器的主进程（负责协调、主控），只有一个

第三方插件进程：每种类型的插件对应一个进程，仅当使用该插件时才创建

GPU进程：最多一个，用于3D绘制

浏览器渲染进程（内核）：默认每个Tab页面一个进程，互不影响，控制页面渲染，脚本执行，事件处理等（有时候会优化，如多个空白tab会合并成一个进程）

如下图：



多线程的浏览器内核
每一个tab页面可以看作是浏览器内核进程，然后这个进程是多线程的，它有几大类子线程：

GUI线程

JS引擎线程

事件触发线程

定时器线程

网络请求线程



可以看到，里面的JS引擎是内核进程中的一个线程，这也是为什么常说JS引擎是单线程的。

### 1.3 解析URL
> 解析URL的目的是什么？
> 

解析URL
输入URL后，会进行解析（URL的本质就是统一资源定位符）

URL一般包括几大部分：

protocol，协议头，譬如有http，ftp等

host，主机域名或IP地址

port，端口号

path，目录路径

query，即查询参数

fragment，即 #后的hash值，一般用来定位到某个位置

网络请求都是单独的线程
每次网络请求时都需要开辟单独的线程进行，譬如如果URL解析到http协议，就会新建一个网络线程去处理资源下载。

因此浏览器会根据解析出得协议，开辟一个网络线程，前往请求资源（这里，暂时理解为是浏览器内核开辟的，如有错误，后续修复）。

更多
由于篇幅关系，这里就大概介绍一个主干流程，关于浏览器的进程机制，更多可以参考以前总结的一篇文章（因为内容实在过多，里面包括JS运行机制，进程线程的详解）。

从浏览器多进程到JS单线程，JS运行机制最全面的一次梳理：https://segmentfault.com/a/1190000012925872。

开启网络线程到发出一个完整的http请求
这一部分主要内容包括： dns查询， tcp/ip请求构建， 五层因特网协议栈等等。

仍然是先梳理主干，有些详细的过程不展开（因为展开的话内容过多）。


## 2. 发起网络请求
> 1. 我们需要知道如何发起网络请求？
> 2. 发起网络请求需要哪些参数？
> 开启网络线程到发出一个完整的http请求（这一部分涉及到dns查询，tcp/ip请求，五层因特网协议栈等知识）

### 2.1 DNS 查询
> DNS查询得到IP
> 输入的是IP还是域名？

DNS解析过程
如果输入的是域名，需要进行dns解析成IP，大致流程：

1.系统会检查浏览器缓存中有没有这个域名对应的解析过的IP地址，如果缓存中有，这个解析过程就将结束。浏览器缓存是受这个域名的失效时间和缓存的空间大小控制的。

2.如果用户的浏览器缓存中没有，浏览器会查找操作系统缓存中即为本地的Host文件。

3.如果本地Host文件中没有那么操作系统会把这个域名发送给这里设置的LocalDNS，也就是本地区的域名服务器。这个DNS通常都提供给你本地互联网接入的一个DNS解析服务。这个专门的域名解析服务器性能都会很好，它们一般都会缓存域名解析结果，当然缓存时间是受域名的失效时间控制的，一般缓存空间不是影响域名失效的主要因素。大约90%的域名解析都到这里就已经完成了，所以LDNS主要承担了域名的解析工作。

4.如果LDNS仍然没有命中，就直接到Root Server域名服务器请求解析

5.根域名服务器返回给本地域名服务器一个所查询的域的主域名服务器（gTLD Server）地址。gTLD是国际顶级域名服务器，如.com，.cn、.org等。全球只有13台左右。

6.本地域名服务器（Local DNS Server）再向上一步返回的gTLD服务器发送请求。

7.接受请求的gTLD服务器查找并返回此域名对应的Name Server域名服务器的地址，这个Name Server通常就是你注册的域名服务器，例如你在某个域名服务提供商申请的域名，那么这个域名解析任务就由这个域名提供商的服务器来完成

8.Name Server域名服务器会查询存储的域名和IP的映射关系表，正常情况下都根据域名得到目标IP记录，连同一个TTL值返回给DNS Server域名服务器。

9.返回该域名对应的IP和TTL值，Local DNS Server会缓存这个域名和IP的对应关系，缓存的时间由TTL值控制。

10.把解析的结果返回给用户，用户根据TTL值缓存在本地系统缓存中，域名解析过程结束。以上的流程可以简化为下图


作者：茉莉儿
链接：https://juejin.im/post/59ba146c6fb9a00a4636d8b6
来源：掘金
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

### 2.2 TCP 连接
我们知道Ip层包裹着tcp报文段把它从源Ip运送到目的Ip，如果过程中出现差错（16位的Ip检验和错误），Ip协议会直接丢弃该数据报并且不生成差错报文。这种情况tcp会发现数据丢失并进行重传。

tcp/ip请求
http的本质就是 tcp/ip请求。

需要了解3次握手规则建立连接以及断开连接时的四次挥手。

tcp将http长报文划分为短报文，通过三次握手与服务端建立连接，进行可靠传输。

三次握手的步骤（抽象派）

客户端：hello，你是server么？

服务端：hello，我是server，你是client么

客户端：yes，我是client

建立连接成功后，接下来就正式传输数据。

然后，待到断开连接时，需要进行四次挥手（因为是全双工的，所以需要四次挥手）。

四次挥手的步骤（抽象派）

主动方：我已经关闭了向你那边的主动通道了，只能被动接收了

被动方：收到通道关闭的信息

被动方：那我也告诉你，我这边向你的主动通道也关闭了

主动方：最后收到数据，之后双方无法通信

tcp/ip的并发限制

浏览器对同一域名下并发的tcp连接是有限制的（2-10个不等）。

而且在http1.0中往往一个资源下载就需要对应一个tcp/ip请求。

所以针对这个瓶颈，又出现了很多的资源优化方案。

get和post的区别

get和post虽然本质都是tcp/ip，但两者除了在http层面外，在tcp/ip层面也有区别。

get会产生一个tcp数据包，post两个。

具体就是：

get请求时，浏览器会把 headers和 data一起发送出去，服务器响应200（返回数据），

post请求时，浏览器先发送 headers，服务器响应 100continue，浏览器再发送 data，服务器响应200（返回数据）。

再说一点，这里的区别是 specification（规范）层面，而不是 implementation（对规范的实现）

五层因特网协议栈
其实这个概念挺难记全的，记不全没关系，但是要有一个整体概念。

其实就是一个概念：从客户端发出http请求到服务器接收，中间会经过一系列的流程。

简括就是：从应用层的发送http请求，到传输层通过三次握手建立tcp/ip连接，再到网络层的ip寻址，再到数据链路层的封装成帧，最后到物理层的利用物理介质传输。

当然，服务端的接收就是反过来的步骤。

五层因特尔协议栈其实就是：
1.应用层(dns,http) DNS解析成IP并发送http请求
2.传输层(tcp,udp) 建立tcp连接（三次握手）
3.网络层(IP,ARP) IP寻址
4.数据链路层(PPP) 封装成帧
5.物理层(利用物理介质传输比特流) 物理传输（然后传输的时候通过双绞线，电磁波等各种介质）

当然，其实也有一个完整的OSI七层框架，与之相比，多了会话层、表示层。

OSI七层框架： 物理层、 数据链路层、 网络层、 传输层、 会话层、 表示层、 应用层。

表示层：主要处理两个通信系统中交换信息的表示方式，包括数据格式交换，数据加密与解密，数据压缩与终端类型转换等

会话层：它具体管理不同用户和进程之间的对话，如控制登陆和注销过程


## 3. 服务端处理请求

## 4. HTTP 请求、响应及缓存

## 5. 浏览器接受数据后如何处理？

## 6. 浏览器如何将页面展现出来？
## 6.1 资源加载

### 6.2 浏览器渲染

> 参考文献